# Solidity

<aside>
ğŸŒ ä»¥ä¸‹ä»£ç å‡åœ¨REMIXä¸­æ“ä½œ

</aside>

# IDE

[REMIX](https://remix.ethereum.org/#optimize=false&runs=200&evmVersion=null&version=soljson-v0.8.7+commit.e28d00a7.js)

# è¯­æ³•

## æ•°æ®ç±»å‹

åŸºç¡€æ•°æ®ç±»å‹

- boolean
- uint
- int
- addressï¼šè¡¨ç¤ºåœ°å€ã€‚ä¾‹å¦‚metamaské‡Œé¢çš„è´¦æˆ·åœ°å€
- bytes

## å˜é‡å®šä¹‰

```solidity
// æ•°æ®ç±»å‹ ï¼ˆå¯è§æ€§ï¼Œé»˜è®¤æ˜¯internalï¼‰ å˜é‡å = å€¼
bool hasFavoriteNumber = true;
uint256 favoriteNumber = 5;
string favoriteNumberInText = "Five";
int256 favoriteInt = -5;
address myAddress = 0x43Af4f57fD990A38b1c9928e936FCbDB5A30034e;
bytes32 favoriteBytes = "cat";
uint256 favoriteNumber;
```

- `string`æ˜¯ä¸€ç§`bytes`ï¼Œä½†æ˜¯`string`åªèƒ½å­˜å‚¨å­—ç¬¦ä¸²ï¼Œä½†æ˜¯`cat`æ˜¯ä¸€ä¸ª`string`ï¼Œä½†æ˜¯å¥¹å¯ä»¥è‡ªåŠ¨è½¬åŒ–ä¸º`bytes`ã€‚`bytes`å˜é‡é€šå¸¸æ˜¯`â€œ0xâ€`å¼€å¤´ç„¶åæœ‰ä¸€äº›éšæœºæ•°å­—å’Œå­—æ¯
- å¯¹äº`uint`æ¥è¯´ï¼Œæœ€å¤šå¯ä»¥è®¾ç½®8ä¸ªbit(uint8)ã€‚å› ä¸º`8bit = 1btyes`ï¼Œæˆ‘ä»¬æŒ‰ç…§byteå¢åŠ ç©ºé—´ã€‚
- `bytes32`æ˜¯bytesç±»å‹å˜é‡è¢«å…è®¸åˆ†é…çš„æœ€å¤šç©ºé—´
- å¦‚æœä¸èµ‹å€¼(`uint256 favoriteNumber;`)ï¼Œå®ƒä¼šè‡ªåŠ¨åˆå§‹åŒ–ä¸º0(è¿™é‡Œåªæ˜¯ä»¥`uint256`ç±»å‹ä¸ºä¾‹)

## å‡½æ•°

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.8; //æŒ‡å®šsolidityçš„ç‰ˆæœ¬ï¼Œå› ä¸ºsolidityæ›´æ–°å¾ˆé¢‘ç¹.^è¡¨ç¤ºæ¯”å½“å‰ç‰ˆæœ¬æ›´æ–°çš„éƒ½å¯ä»¥ã€‚>=0.8.7 < 0.9.0

contract SimpleStorage {
    uint256 public favoriteNumber;

    function store(uint256 _favoriteNumber) public {
        favoriteNumber = _favoriteNumber;
        favoriteNumber = favoriteNumber + 1;

    }

    function retrieve() public view returns(uint256) {
        return favoriteNumber;
    }

}
```

å‡½æ•°çš„å¯è§ç±»å‹ï¼š

- public: ä»»ä½•ä¸åˆçº¦äº¤äº’çš„äººï¼Œéƒ½å¯ä»¥çœ‹åˆ°`favoriteNumber`ä¸­å­˜çš„å€¼ã€‚publicä¼šåˆ›å»º`getter`å‡½æ•°ï¼Œç”¨æ¥è·å–å˜é‡çš„å€¼ã€‚
- private: æ˜¯æœ‰è¿™ä¸ªåˆçº¦å¯ä»¥è¯»åˆ°è¿™ä¸ªå€¼ã€‚
- external: åªå¯¹åˆçº¦å¤–éƒ¨å¯è§ï¼Œè¡¨ç¤ºåˆçº¦å¤–çš„è´¦æˆ·å¯ä»¥è°ƒç”¨è¿™ä¸ªå‡½æ•°
- internal:åªæœ‰è¿™ä¸ªåˆçº¦æˆ–è€…ç»§æ‰¿ä»–çš„åˆçº¦å¯ä»¥è¯»å–ã€‚

å¦‚æœæ²¡æœ‰å¯è§æ ‡è¯†ï¼Œé»˜è®¤æ˜¯`internal`

åšè¶Šå¤šçš„æ“ä½œï¼Œæ¶ˆè€—è¶Šå¤šgas

**solidityä¸­æœ‰ä¸¤ä¸ªå…³é”®å­—ï¼Œæ ‡è¯†å‡½æ•°çš„è°ƒç”¨ä¸éœ€è¦æ¶ˆè€—gasï¼š**

- viewï¼šå¦‚æœä¸€ä¸ªå‡½æ•°æ˜¯viewå‡½æ•°ï¼Œæ„å‘³ç€å‡½æ•°åªä¼šè¯»å–è¿™ä¸ªåˆçº¦çš„çŠ¶æ€ã€‚viewå‡½æ•°ä¸ å…è®¸ä¿®æ”¹ä»»ä½•çŠ¶æ€ï¼Œä¹Ÿä¸èƒ½åœ¨viewå‡½æ•°ä¸­ä¿®æ”¹çŠ¶æ€ã€‚
- pureï¼šä¸å…è®¸ä¿®æ”¹çŠ¶æ€ï¼Œä¹Ÿä¸èƒ½åœ¨pureå‡½æ•°ä¸­ä¿®æ”¹çŠ¶æ€ã€‚ä½†æ˜¯pureä¹Ÿä¸å…è®¸è¯»å–åŒºå—é“¾æ•°æ®ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½è¯»å–`favoriteNumber`çš„å€¼ã€‚pureå‡½æ•°åªèƒ½ç¼–å†™ä¸€äº›ä¸éœ€è¦è¯»å–æ•°æ®çš„ç®—æ³•ï¼Œä¾‹å¦‚ï¼š
    
    ```solidity
    function add() public pure returns(uint256){
            return (1 + 1);
    }
    ```
    

å¦‚æœæ˜¯åœ¨è¦æ”¹å˜åŒºå—é“¾çŠ¶æ€çš„å‡½æ•°é‡Œè°ƒç”¨äº†view/pureå‡½æ•°ï¼Œæ˜¯éœ€è¦æ¶ˆè€—gasçš„ï¼Œä¾‹å¦‚ï¼š

```solidity
function store(uint256 _favoriteNumber) public {
        favoriteNumber = _favoriteNumber;
        retrieve();

    }
```

## æ•°ç»„å’Œç»“æ„ä½“

### ç»“æ„ä½“

```solidity
People public persion = People({favoriteNumber: 2, name: "cxy"});

struct People {
    uint256 favoriteNumber;
    string name;
}
```

### æ•°ç»„

æ•°ç»„æ˜¯å­˜å‚¨åˆ—è¡¨ï¼Œæˆ–è€…è¯´å­˜å‚¨ä¸€ç³»åˆ—å¯¹è±¡çš„ä¸€ç§æ–¹å¼ã€‚

```solidity
People[] public people;
People[3] public people; // æœ€å¤šæ‹¥æœ‰3ä¸ªå¯¹è±¡
```

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.8; //æŒ‡å®šsolidityçš„ç‰ˆæœ¬ï¼Œå› ä¸ºsolidityæ›´æ–°å¾ˆé¢‘ç¹.^è¡¨ç¤ºæ¯”å½“å‰ç‰ˆæœ¬æ›´æ–°çš„éƒ½å¯ä»¥ã€‚>=0.8.7 < 0.9.0

contract SimpleStorage {
    uint256 favoriteNumber;
    

    struct People {
        uint256 favoriteNumber;
        string name;
    }

    People[] public people;

    function store(uint256 _favoriteNumber) public {
        favoriteNumber = _favoriteNumber;

    }

    function retrieve() public view returns(uint256) {
        return favoriteNumber;
    }

    function addPerson(string memory _name, uint256 _favoriteNumber) public {
        // People memory newPerson = People({favoriteNumber: _favoriteNumber, name: _name});
        People memory newPerson = People(_favoriteNumber, _name);
        people.push(newPerson);
    }
}
```

## Memoryã€Storageå’ŒCalldata

åœ¨Solidityä¸­æœ‰6ç§æ–¹å¼å¯ä»¥å­˜å‚¨æ•°æ®ï¼š

- Stack
- Memoryï¼šæ„å‘³ç€æ•°æ®åªæ˜¯çŸ­æš‚å­˜åœ¨ï¼Œå¯ä»¥ä¿®æ”¹
- Storageï¼šå­˜åœ¨æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ä¹‹å¤–ï¼Œå¯ä»¥ä¿®æ”¹
- Calldata: æ„å‘³ç€æ•°æ®åªæ˜¯çŸ­æš‚å­˜åœ¨ï¼Œå¹¶ä¸”ä¸èƒ½è¢«ä¿®æ”¹ã€‚
- Code
- Logs

<aside>
âš ï¸ æˆ‘ä»¬ä¸èƒ½è¯´ä¸€ä¸ªå˜é‡æ˜¯Stackã€Codeæˆ–Logsï¼Œæˆ‘ä»¬åªèƒ½è¯´å˜é‡æ˜¯Memoryã€Storageæˆ–Calldata

</aside>

arrayã€structå’Œmappingåœ¨solidityä¸­è¢«è®¤ä¸ºæ˜¯ç‰¹æ®Šç±»å‹ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œstringæ˜¯å¾ˆç‰¹æ®Šï¼Œä»åŸç†æ¥è®²ï¼Œä¸€ä¸ªstringå®é™…ä¸Šæ˜¯ä¸€ä¸ªbytesæ•°ç»„ï¼Œå› æ­¤éœ€è¦åŠ memoryã€‚å› ä¸ºæˆ‘ä»¬éœ€è¦è®©solidityçŸ¥é“è¿™ä¸‰ç§æ•°æ®ç±»å‹çš„æ•°æ®ä½ç½®ã€‚

æ€»ç»“ä¸€ä¸‹ï¼Œarrayã€structå’Œmappingåœ¨ä½œä¸ºå‚æ•°è¢«æ·»åŠ åˆ°ä¸åŒçš„å‡½æ•°æ—¶ï¼Œéœ€è¦ç»™å®šä¸€ä¸ª`memory`å…³é”®å­—

## Mappings

mappingæ˜¯ä¸€ç»„é”®å€¼å¯¹ï¼Œæ¯ä¸ªkeyè¿”å›ä¸è¯¥é”®å…³è”çš„æŸä¸ªvalueå€¼ã€‚å¯ä»¥æƒ³è±¡æˆå­—å…¸

```solidity
mapping(string => uint256) public nameToFavoriteNumber;
```

ä¸Šè¿°ä¾‹å­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œvalueä¼šæ˜¯0ã€‚

## import

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "./SimpleStorage.sol";

contract StorageFactory {

    SimpleStorage[] public simpleStorageArray;

    function createSimpleStorageContract() public {
        // StorageFactoryåˆçº¦å¦‚ä½•çŸ¥é“SimpleStorageåˆçº¦æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ
        SimpleStorage simpleStorage = new SimpleStorage();
        simpleStorageArray.push(simpleStorage);
    }

    function sfStore(uint256 _simpleStorageIndex, uint256 _simpleStorageNumber) public {
        // Address 
        // ABI - Application Binary Interface
    }

}
```

- ABI - Application Binary Interfaceã€‚å®ƒæ˜¾ç¤ºäº†æ‰€æœ‰ä¸åŒçš„è¾“å…¥å’Œè¾“å‡ºï¼Œå³è¿™ä¸ªåˆçº¦èƒ½åšçš„æ‰€æœ‰çš„äº‹æƒ…ã€‚
    
    ```solidity
    [
    	{
    		"inputs": [],
    		"name": "createSimpleStorageContract",
    		"outputs": [],
    		"stateMutability": "nonpayable",
    		"type": "function"
    	},
    	{
    		"inputs": [
    			{
    				"internalType": "uint256",
    				"name": "_simpleStorageIndex",
    				"type": "uint256"
    			},
    			{
    				"internalType": "uint256",
    				"name": "_simpleStorageNumber",
    				"type": "uint256"
    			}
    		],
    		"name": "sfStore",
    		"outputs": [],
    		"stateMutability": "nonpayable",
    		"type": "function"
    	},
    	{
    		"inputs": [
    			{
    				"internalType": "uint256",
    				"name": "",
    				"type": "uint256"
    			}
    		],
    		"name": "simpleStorageArray",
    		"outputs": [
    			{
    				"internalType": "contract SimpleStorage",
    				"name": "",
    				"type": "address"
    			}
    		],
    		"stateMutability": "view",
    		"type": "function"
    	}
    ]
    ```
    

## ç»§æ‰¿å’Œé‡è½½

ç»§æ‰¿ä½¿ç”¨`is`å…³é”®å­—ã€‚é‡å†™çš„æ–¹æ³•éœ€è¦ç”¨`override`å…³é”®å­—ï¼Œå¹¶ä¸”çˆ¶contractè¢«é‡å†™çš„æ–¹æ³•éœ€è¦åŠ ä¸Š`virtual`å…³é”®å­—

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.8; //æŒ‡å®šsolidityçš„ç‰ˆæœ¬ï¼Œå› ä¸ºsolidityæ›´æ–°å¾ˆé¢‘ç¹.^è¡¨ç¤ºæ¯”å½“å‰ç‰ˆæœ¬æ›´æ–°çš„éƒ½å¯ä»¥ã€‚>=0.8.7 < 0.9.0

import "./SimpleStorage.sol";

contract ExtraSimpleStorage is SimpleStorage {
    // +5
    // override
    function store(uint256 _favoriteNumber) public override {
        favoriteNumber = _favoriteNumber + 5;
    }
}
```

```solidity
function store(uint256 _favoriteNumber) public virtual {
        favoriteNumber = _favoriteNumber;

    }
```

## payable

```solidity
function fund() public payable{
        // want to be able to set a minimum fund amount in USD
        // 1. How do we set ETH to this contract
        require(msg.value > 1e18, "Didn't send enough!"); // 1e18 == 1 * 10 **18 == 10000000000000000
    }
```

å¦‚æœæ²¡æœ‰æ»¡è¶³`require`çš„æ¡ä»¶ï¼Œé‚£ä¹ˆæ•´ä¸ªäº¤æ˜“ä¼šè¢«`revert`ã€‚

<aside>
ğŸŒ what is reverting?
undo any action before, and send remaining gas back.

</aside>

## library

åº“å’Œæ™ºèƒ½åˆçº¦ç±»ä¼¼ï¼Œä½†æ˜¯ä½ ä¸èƒ½å£°æ˜ä»»ä½•é™æ€å˜é‡ï¼Œä¹Ÿä¸èƒ½å‘é€ethã€‚å¦‚æœæ‰€æœ‰åº“å‡½æ•°éƒ½æ˜¯å†…éƒ¨çš„ï¼Œåˆ™åº“å°†åµŒå…¥åˆ°åˆçº¦ä¸­ã€‚å¦åˆ™ï¼Œå¿…é¡»åœ¨éƒ¨ç½²åˆçº¦ä¹‹å‰éƒ¨ç½²å¹¶é“¾æ¥åº“ã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol";

library PriceConvertor {
    function getPrice() internal view returns(uint256) {
        AggregatorV3Interface priceFeeds = AggregatorV3Interface(0xD4a33860578De61DBAbDc8BFdb98FD742fA7028e);
        (,int256 price,,,) = priceFeeds.latestRoundData();
        return uint256(price * 1e10); 

    }

    function getVersion() internal view returns(uint256) {
        AggregatorV3Interface priceFeeds = AggregatorV3Interface(0xD4a33860578De61DBAbDc8BFdb98FD742fA7028e);
        return priceFeeds.version();
    }

    function getConversionRate(uint256 ethAmount) internal view returns(uint256){
        uint256 ethPrice = getPrice();
        uint256 ethAmountInUsd = (ethPrice * ethAmount) / 1e18 ;
        rerturn ethAmountInUsd;
    }
}
```

```solidity
// Get funds from users;
// Withdraw funds
// Set a minimum funding value in USD;
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.8; //æŒ‡å®šsolidityçš„ç‰ˆæœ¬ï¼Œå› ä¸ºsolidityæ›´æ–°å¾ˆé¢‘ç¹.^è¡¨ç¤ºæ¯”å½“å‰ç‰ˆæœ¬æ›´æ–°çš„éƒ½å¯ä»¥ã€‚>=0.8.7 < 0.9.0

import "./PriceConverter.sol";

contract FundMe {
    using PriceConvertor for uint256;

    uint256 public minimumUsed = 50 * 1e18;

    address[] funders;
    mapping(address => uint256) public addressToAmountFunded;

    function fund() public payable{
        // want to be able to set a minimum fund amount in USD
        // 1. How do we set ETH to this contract
        require(msg.value.getConversionRate() >= minimumUsed, "Didn't send enough!"); // 1e18 == 1 * 10 **18 == 10000000000000000
        funders.push(msg.sender);
        addressToAmountFunded[msg.sender] = msg.value;
    }

    // function withdraw {
 
    // }
}
```

## SafeMathã€æº¢å‡ºæ£€æŸ¥å’Œuncheckedå…³é”®å­—

åœ¨solidity0.8.0ä¹‹å‰ï¼Œæ— ç¬¦å·æ•´å‹å’Œæ•´å‹æ˜¯è¿è¡Œåœ¨uncheckedè¿™ä¸ªæ¦‚å¿µä¸‹çš„ï¼Œæ„å‘³ç€å½“ä½ è¶…è¿‡ä¸€ä¸ªæ•°å­—çš„èŒƒå›´ï¼Œä»–åªä¼šç»•å›å»å¹¶ä»å¯èƒ½çš„æœ€ä½æ•°å­—å¼€å§‹ã€‚ä¾‹å¦‚`uint8 public bigNumber = 255`;å½“æ‰§è¡Œ`bigNumber = bigNumber + 1;`æ—¶ï¼Œ`bigNumber`ä¼šå˜ä¸º`0`ã€‚

åœ¨solidity0.8.0ä¹‹åï¼Œå®ƒä¼šè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦å¯¹å˜é‡æ‰§è¡Œäº†æº¢å‡ºï¼ˆæˆ–ä¸‹æº¢ï¼‰ã€‚

å¯ä»¥ç”¨`unchecked`å…³é”®å­—å°†è¯­æ³•å®ç°å˜ä¸º0.8.0ç‰ˆæœ¬ä¹‹å‰çš„æ ·å­ï¼š

```solidity
unchecked {bigNumber = bigNumber + 1;}
```

`unchecked`å¯ä»¥èŠ‚çœgasã€‚

## for

```solidity
for(uint256 funderIndex = 0; funderIndex < funders.length; funderIndex++){
            address funder = funders[funderIndex];
            addressToAmountFunded[funder] = 0
        }
```

## é‡ç½®æ•°ç»„

```solidity
funders = new address[](0);
```

## sendã€transferã€call

### transfer

transferæœ€å¤šæ¶ˆè€—2300gasï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªä¸Šé™ï¼Œä»–ä¼šæŠ¥é”™

```solidity
payable(msg.sender).transfer(address(this).balance);
```

`msg.sender`æ˜¯`address`ç±»å‹ï¼›`payable(msg.sender)`æ˜¯`payable address`ç±»å‹

### send

sendæœ€å¤šæ¶ˆè€—2300gasï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªä¸Šé™ï¼Œä»–ä¸ä¼šæŠ¥é”™ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªè¡¨ç¤ºè¿è¡Œæ˜¯å¦æˆåŠŸçš„å¸ƒå°”å€¼ã€‚å¦‚æœå¸Œæœ›æŠ›å‡ºå¼‚å¸¸ï¼Œéœ€è¦ç”¨`require`

```solidity
bool sendSuccess = payable(msg.sender).send(address(this).balance);
require(sendSuccess, "Send failed")
```

### call

ä»–å¯ä»¥è°ƒç”¨å‡ ä¹æ‰€æœ‰çš„solidityå‡½æ•°ã€‚æ²¡æœ‰gasé™åˆ¶ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®gas

```solidity
(bool callSuccess,) = payable(msg.sender).call{value: address(this).balance}("")
require(sendSuccess, "Send failed")
```

## æ„é€ å‡½æ•°

åœ¨éƒ¨ç½²åˆçº¦åç«‹å³è°ƒç”¨ä¸€æ¬¡

```solidity
constructor() {
   owner = msg.sender  // msg.senderå°±æ˜¯éƒ¨ç½²åˆçº¦çš„äºº
}
```

## modifierè£…é¥°å™¨

```solidity
modifier OnlyOwner {
    require(msg.sender == owner, "Sender is not owner!");
    _;
}
```

```solidity
function withdraw() public OnlyOwner {
        /* starting index, ending index, step amount */
        for(uint256 funderIndex = 0; funderIndex < funders.length; funderIndex++){
            address funder = funders[funderIndex];
            addressToAmountFunded[funder] = 0;
        }

        funders = new address[](0);

        // payable(msg.sender).transfer(address(this).balance);

        // bool sendSuccess = payable(msg.sender).send(address(this).balance);
        // require(sendSuccess, "Send failed")

        (bool callSuccess,) = payable(msg.sender).call{value: address(this).balance}("");
        require(callSuccess, "Send failed");
    }
```

## Immutable & Constant

constantä½¿å¾—å˜é‡ä¸å†å ç”¨å­˜å‚¨ç©ºé—´

```solidity
uint256 public constant minimumUsed = 50 * 1e18;
address public immutable i_owner;
```

## è‡ªå®šä¹‰error

```solidity
error NotOwner();
if (msg.sender != i_owner) {
            revert NotOwner();
        }
```

## Receive & Fallback

![Untitled](Solidity%20da852d9f671447709bb8d966e226241e/Untitled.png)

```solidity
receive() external payable {
        result = 1;
    }
fallback() external payable {
        result = 2;
    }
```